openapi: 3.0.3
info:
  title: API финансового трекера
  version: 1.0.0
  description: |
    HTTP API для Finance Tracker. Охватывает аутентификацию, счета, категории, транзакции,
    бюджеты, регулярные операции, долги, кредитные продукты, цели накоплений, события и отчёты.
servers:
  - url: https://api.example.com
    description: Продакшн
  - url: https://sandbox.api.example.com
    description: Песочница
security:
  - bearerAuth: []
tags:
  - name: Auth
  - name: Users
  - name: Accounts
  - name: Categories
  - name: Transactions
  - name: Budgets
  - name: Recurring
  - name: Debts
  - name: Credit
  - name: Savings
  - name: Events
  - name: Reports
components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
  parameters:
    LimitParam:
      name: limit
      in: query
      schema: { type: integer, minimum: 1, maximum: 200, default: 50 }
      description: Максимум элементов в ответе
    CursorParam:
      name: cursor
      in: query
      schema: { type: string }
      description: Курсор для следующей/предыдущей страницы
    FromDateParam:
      name: from
      in: query
      schema: { type: string, format: date }
      description: Начальная дата включительно
    ToDateParam:
      name: to
      in: query
      schema: { type: string, format: date }
      description: Конечная дата включительно
    AccountIdParam:
      name: accountId
      in: query
      schema: { type: string, format: uuid }
    CategoryIdParam:
      name: categoryId
      in: query
      schema: { type: string, format: uuid }
    SortParam:
      name: sort
      in: query
      schema: { type: string }
      description: Поля через запятую, напр. occurredAt:desc,amount:asc
  schemas:
    ErrorResponse:
      type: object
      required: [error]
      properties:
        error:
          type: object
          required: [code, message]
          properties:
            code: { type: string }
            message: { type: string }
            details: { type: object, additionalProperties: true }
    Meta:
      type: object
      properties:
        nextCursor: { type: string, nullable: true }
        prevCursor: { type: string, nullable: true }
        total: { type: integer, nullable: true }
    User:
      type: object
      required: [id, email]
      properties:
        id: { type: string, format: uuid }
        email: { type: string, format: email }
        name: { type: string }
        defaultCurrency: { type: string, example: USD }
        createdAt: { type: string, format: date-time }
    AccountType:
      type: string
      enum: [cash, bank, card, investment]
    Account:
      type: object
      required: [id, userId, name, type, currency]
      properties:
        id: { type: string, format: uuid }
        userId: { type: string, format: uuid }
        name: { type: string }
        type: { $ref: '#/components/schemas/AccountType' }
        currency: { type: string, example: USD }
        createdAt: { type: string, format: date-time }
        archived: { type: boolean, default: false }
    CategoryType:
      type: string
      enum: [income, expense]
    Category:
      type: object
      required: [id, userId, name, type]
      properties:
        id: { type: string, format: uuid }
        userId: { type: string, format: uuid }
        name: { type: string }
        type: { $ref: '#/components/schemas/CategoryType' }
        parentId: { type: string, format: uuid, nullable: true }
        color: { type: string, nullable: true }
        archived: { type: boolean, default: false }
    TransactionType:
      type: string
      enum: [income, expense, transfer]
    Transaction:
      type: object
      required: [id, userId, type, amount, currency, occurredAt]
      properties:
        id: { type: string, format: uuid }
        userId: { type: string, format: uuid }
        type: { $ref: '#/components/schemas/TransactionType' }
        accountId: { type: string, format: uuid, nullable: true }
        categoryId: { type: string, format: uuid, nullable: true }
        fromAccountId: { type: string, format: uuid, nullable: true }
        toAccountId: { type: string, format: uuid, nullable: true }
        feeAmount: { type: integer, nullable: true, description: Сумма в минорных единицах }
        amount: { type: integer, description: Сумма в минорных единицах }
        currency: { type: string, example: USD }
        occurredAt: { type: string, format: date-time }
        notes: { type: string, nullable: true }
        tags:
          type: array
          items: { type: string }
    BudgetPeriod:
      type: string
      enum: [monthly, weekly, custom]
    BudgetAllocation:
      type: object
      required: [categoryId, limitAmount]
      properties:
        categoryId: { type: string, format: uuid }
        limitAmount: { type: integer, description: Лимит в минорных единицах }
    Budget:
      type: object
      required: [id, userId, period, startDate]
      properties:
        id: { type: string, format: uuid }
        userId: { type: string, format: uuid }
        period: { $ref: '#/components/schemas/BudgetPeriod' }
        startDate: { type: string, format: date }
        endDate: { type: string, format: date, nullable: true }
        allocations:
          type: array
          items: { $ref: '#/components/schemas/BudgetAllocation' }
        rollover: { type: boolean, default: false }
    RecurringType:
      type: string
      enum: [income, expense]
    RecurringItemStatus:
      type: string
      enum: [active, paused]
    RecurringItem:
      type: object
      required: [id, userId, type, categoryId, accountId, amount, currency, schedule]
      properties:
        id: { type: string, format: uuid }
        userId: { type: string, format: uuid }
        type: { $ref: '#/components/schemas/RecurringType' }
        categoryId: { type: string, format: uuid }
        accountId: { type: string, format: uuid }
        amount: { type: integer }
        currency: { type: string, example: USD }
        schedule: { type: string, description: Cron или RRULE }
        nextRunAt: { type: string, format: date-time, nullable: true }
        lastRunAt: { type: string, format: date-time, nullable: true }
        status: { $ref: '#/components/schemas/RecurringItemStatus' }
    DebtRole:
      type: string
      enum: [lent, borrowed]
    DebtStatus:
      type: string
      enum: [active, closed, defaulted]
    DebtPayment:
      type: object
      required: [id, amount, occurredAt]
      properties:
        id: { type: string, format: uuid }
        amount: { type: integer }
        occurredAt: { type: string, format: date-time }
        interestPortion: { type: integer, nullable: true }
        principalPortion: { type: integer, nullable: true }
    Debt:
      type: object
      required: [id, userId, role, principal, startDate]
      properties:
        id: { type: string, format: uuid }
        userId: { type: string, format: uuid }
        role: { $ref: '#/components/schemas/DebtRole' }
        counterparty: { type: string, nullable: true }
        principal: { type: integer }
        interestRateAPR: { type: number, format: float, example: 15.99 }
        startDate: { type: string, format: date }
        dueDate: { type: string, format: date, nullable: true }
        schedule: { type: string, example: monthly }
        status: { $ref: '#/components/schemas/DebtStatus' }
        payments:
          type: array
          items: { $ref: '#/components/schemas/DebtPayment' }
    CreditFacility:
      type: object
      required: [id, userId, name, limitAmount]
      properties:
        id: { type: string, format: uuid }
        userId: { type: string, format: uuid }
        name: { type: string }
        limitAmount: { type: integer }
        availableAmount: { type: integer }
        apr: { type: number, format: float }
        statementDay: { type: integer, minimum: 1, maximum: 31 }
        paymentDueDay: { type: integer, minimum: 1, maximum: 31 }
    SavingGoal:
      type: object
      required: [id, userId, name, targetAmount]
      properties:
        id: { type: string, format: uuid }
        userId: { type: string, format: uuid }
        name: { type: string }
        targetAmount: { type: integer }
        currentAmount: { type: integer }
        dueDate: { type: string, format: date, nullable: true }
        priority: { type: integer, nullable: true }
    Event:
      type: object
      required: [id, userId, name, date]
      properties:
        id: { type: string, format: uuid }
        userId: { type: string, format: uuid }
        name: { type: string }
        date: { type: string, format: date }
        expectedSpendAmount: { type: integer, nullable: true }
        notes: { type: string, nullable: true }
paths:
  /auth/register:
    post:
      tags: [Auth]
      summary: Регистрация нового пользователя
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [email, password]
              properties:
                email: { type: string, format: email }
                password: { type: string, format: password }
                name: { type: string }
      responses:
        '201':
          description: Зарегистрирован
          content:
            application/json:
              schema:
                type: object
                properties:
                  user: { $ref: '#/components/schemas/User' }
                  accessToken: { type: string }
        '400': { description: Неверный запрос, content: { application/json: { schema: { $ref: '#/components/schemas/ErrorResponse' } } } }
  /auth/login:
    post:
      tags: [Auth]
      summary: Вход и получение токена доступа
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [email, password]
              properties:
                email: { type: string, format: email }
                password: { type: string, format: password }
      responses:
        '200':
          description: Аутентифицирован
          content:
            application/json:
              schema:
                type: object
                properties:
                  user: { $ref: '#/components/schemas/User' }
                  accessToken: { type: string }
        '401': { description: Неавторизовано }
  /me:
    get:
      tags: [Users]
      summary: Получить текущего пользователя
      responses:
        '200': { description: OK, content: { application/json: { schema: { $ref: '#/components/schemas/User' } } } }
        '401': { description: Неавторизовано }
  /accounts:
    get:
      tags: [Accounts]
      summary: Список счетов
      parameters:
        - $ref: '#/components/parameters/LimitParam'
        - $ref: '#/components/parameters/CursorParam'
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: array
                    items: { $ref: '#/components/schemas/Account' }
                  meta: { $ref: '#/components/schemas/Meta' }
    post:
      tags: [Accounts]
      summary: Создать счёт
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [name, type, currency]
              properties:
                name: { type: string }
                type: { $ref: '#/components/schemas/AccountType' }
                currency: { type: string }
      responses:
        '201': { description: Создано, content: { application/json: { schema: { $ref: '#/components/schemas/Account' } } } }
  /accounts/{id}:
    get:
      tags: [Accounts]
      summary: Получить счёт
      parameters:
        - name: id
          in: path
          required: true
          schema: { type: string, format: uuid }
      responses:
        '200': { description: OK, content: { application/json: { schema: { $ref: '#/components/schemas/Account' } } } }
        '404': { description: Не найдено }
    patch:
      tags: [Accounts]
      summary: Обновить счёт
      parameters:
        - name: id
          in: path
          required: true
          schema: { type: string, format: uuid }
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                name: { type: string }
                archived: { type: boolean }
      responses:
        '200': { description: OK, content: { application/json: { schema: { $ref: '#/components/schemas/Account' } } } }
    delete:
      tags: [Accounts]
      summary: Удалить счёт
      parameters:
        - name: id
          in: path
          required: true
          schema: { type: string, format: uuid }
      responses:
        '204': { description: Нет содержимого }
  /categories:
    get:
      tags: [Categories]
      summary: Список категорий
      responses:
        '200': { description: OK, content: { application/json: { schema: { type: object, properties: { data: { type: array, items: { $ref: '#/components/schemas/Category' } } } } } } }
    post:
      tags: [Categories]
      summary: Создать категорию
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [name, type]
              properties:
                name: { type: string }
                type: { $ref: '#/components/schemas/CategoryType' }
                parentId: { type: string, format: uuid }
      responses:
        '201': { description: Создано, content: { application/json: { schema: { $ref: '#/components/schemas/Category' } } } }
  /transactions:
    get:
      tags: [Transactions]
      summary: Список транзакций
      parameters:
        - $ref: '#/components/parameters/LimitParam'
        - $ref: '#/components/parameters/CursorParam'
        - $ref: '#/components/parameters/FromDateParam'
        - $ref: '#/components/parameters/ToDateParam'
        - $ref: '#/components/parameters/AccountIdParam'
        - $ref: '#/components/parameters/CategoryIdParam'
        - $ref: '#/components/parameters/SortParam'
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: array
                    items: { $ref: '#/components/schemas/Transaction' }
                  meta: { $ref: '#/components/schemas/Meta' }
    post:
      tags: [Transactions]
      summary: Создать транзакцию
      requestBody:
        required: true
        content:
          application/json:
            schema:
              oneOf:
                - title: Доход
                  type: object
                  required: [type, accountId, categoryId, amount, currency, occurredAt]
                  properties:
                    type: { enum: [income] }
                    accountId: { type: string, format: uuid }
                    categoryId: { type: string, format: uuid }
                    amount: { type: integer }
                    currency: { type: string }
                    occurredAt: { type: string, format: date-time }
                    notes: { type: string }
                - title: Расход
                  type: object
                  required: [type, accountId, categoryId, amount, currency, occurredAt]
                  properties:
                    type: { enum: [expense] }
                    accountId: { type: string, format: uuid }
                    categoryId: { type: string, format: uuid }
                    amount: { type: integer }
                    currency: { type: string }
                    occurredAt: { type: string, format: date-time }
                    notes: { type: string }
                - title: Перевод
                  type: object
                  required: [type, fromAccountId, toAccountId, amount, currency, occurredAt]
                  properties:
                    type: { enum: [transfer] }
                    fromAccountId: { type: string, format: uuid }
                    toAccountId: { type: string, format: uuid }
                    amount: { type: integer }
                    currency: { type: string }
                    occurredAt: { type: string, format: date-time }
                    feeAmount: { type: integer }
                    notes: { type: string }
      responses:
        '201': { description: Создано, content: { application/json: { schema: { $ref: '#/components/schemas/Transaction' } } } }
  /budgets:
    get:
      tags: [Budgets]
      summary: Список бюджетов
      responses:
        '200': { description: OK, content: { application/json: { schema: { type: object, properties: { data: { type: array, items: { $ref: '#/components/schemas/Budget' } } } } } } }
    post:
      tags: [Budgets]
      summary: Создать бюджет
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [period, startDate, allocations]
              properties:
                period: { $ref: '#/components/schemas/BudgetPeriod' }
                startDate: { type: string, format: date }
                endDate: { type: string, format: date }
                allocations:
                  type: array
                  items: { $ref: '#/components/schemas/BudgetAllocation' }
                rollover: { type: boolean }
      responses:
        '201': { description: Создано, content: { application/json: { schema: { $ref: '#/components/schemas/Budget' } } } }
  /recurring:
    get:
      tags: [Recurring]
      summary: Список регулярных операций
      responses:
        '200': { description: OK, content: { application/json: { schema: { type: object, properties: { data: { type: array, items: { $ref: '#/components/schemas/RecurringItem' } } } } } } }
    post:
      tags: [Recurring]
      summary: Создать регулярный доход/расход
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [type, categoryId, accountId, amount, currency, schedule]
              properties:
                type: { $ref: '#/components/schemas/RecurringType' }
                categoryId: { type: string, format: uuid }
                accountId: { type: string, format: uuid }
                amount: { type: integer }
                currency: { type: string }
                schedule: { type: string }
      responses:
        '201': { description: Создано, content: { application/json: { schema: { $ref: '#/components/schemas/RecurringItem' } } } }
  /recurring/{id}/run:
    post:
      tags: [Recurring]
      summary: Выполнить генерацию сейчас (идемпотентно)
      parameters:
        - name: id
          in: path
          required: true
          schema: { type: string, format: uuid }
      responses:
        '200': { description: OK, content: { application/json: { schema: { type: object, properties: { createdTransactions: { type: array, items: { $ref: '#/components/schemas/Transaction' } } } } } } }
  /debts:
    get:
      tags: [Debts]
      summary: Список долгов
      responses:
        '200': { description: OK, content: { application/json: { schema: { type: object, properties: { data: { type: array, items: { $ref: '#/components/schemas/Debt' } } } } } } }
    post:
      tags: [Debts]
      summary: Создать долг
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [role, principal, interestRateAPR, startDate]
              properties:
                role: { $ref: '#/components/schemas/DebtRole' }
                counterparty: { type: string }
                principal: { type: integer }
                interestRateAPR: { type: number, format: float }
                startDate: { type: string, format: date }
                dueDate: { type: string, format: date }
                schedule: { type: string, example: monthly }
      responses:
        '201': { description: Создано, content: { application/json: { schema: { $ref: '#/components/schemas/Debt' } } } }
  /debts/{id}:
    get:
      tags: [Debts]
      summary: Получить долг
      parameters:
        - name: id
          in: path
          required: true
          schema: { type: string, format: uuid }
      responses:
        '200': { description: OK, content: { application/json: { schema: { $ref: '#/components/schemas/Debt' } } } }
    patch:
      tags: [Debts]
      summary: Обновить долг
      parameters:
        - name: id
          in: path
          required: true
          schema: { type: string, format: uuid }
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                status: { $ref: '#/components/schemas/DebtStatus' }
      responses:
        '200': { description: OK, content: { application/json: { schema: { $ref: '#/components/schemas/Debt' } } } }
  /debts/{id}/payments:
    get:
      tags: [Debts]
      summary: Список платежей по долгу
      parameters:
        - name: id
          in: path
          required: true
          schema: { type: string, format: uuid }
      responses:
        '200': { description: OK, content: { application/json: { schema: { type: object, properties: { data: { type: array, items: { $ref: '#/components/schemas/DebtPayment' } } } } } } }
    post:
      tags: [Debts]
      summary: Добавить платёж
      parameters:
        - name: id
          in: path
          required: true
          schema: { type: string, format: uuid }
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [amount, occurredAt]
              properties:
                amount: { type: integer }
                occurredAt: { type: string, format: date-time }
      responses:
        '201': { description: Создано, content: { application/json: { schema: { $ref: '#/components/schemas/DebtPayment' } } } }
  /credit-facilities:
    get:
      tags: [Credit]
      summary: Список кредитных продуктов
      responses:
        '200': { description: OK, content: { application/json: { schema: { type: object, properties: { data: { type: array, items: { $ref: '#/components/schemas/CreditFacility' } } } } } } }
    post:
      tags: [Credit]
      summary: Создать кредитный продукт
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [name, limitAmount]
              properties:
                name: { type: string }
                limitAmount: { type: integer }
                apr: { type: number, format: float }
                statementDay: { type: integer }
                paymentDueDay: { type: integer }
      responses:
        '201': { description: Создано, content: { application/json: { schema: { $ref: '#/components/schemas/CreditFacility' } } } }
  /saving-goals:
    get:
      tags: [Savings]
      summary: Список целей накоплений
      responses:
        '200': { description: OK, content: { application/json: { schema: { type: object, properties: { data: { type: array, items: { $ref: '#/components/schemas/SavingGoal' } } } } } } }
    post:
      tags: [Savings]
      summary: Создать цель накоплений
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [name, targetAmount]
              properties:
                name: { type: string }
                targetAmount: { type: integer }
                dueDate: { type: string, format: date }
      responses:
        '201': { description: Создано, content: { application/json: { schema: { $ref: '#/components/schemas/SavingGoal' } } } }
  /events:
    get:
      tags: [Events]
      summary: Список событий
      responses:
        '200': { description: OK, content: { application/json: { schema: { type: object, properties: { data: { type: array, items: { $ref: '#/components/schemas/Event' } } } } } } }
    post:
      tags: [Events]
      summary: Создать событие
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [name, date]
              properties:
                name: { type: string }
                date: { type: string, format: date }
                expectedSpendAmount: { type: integer }
                notes: { type: string }
      responses:
        '201': { description: Создано, content: { application/json: { schema: { $ref: '#/components/schemas/Event' } } } }
  /reports/cashflow:
    get:
      tags: [Reports]
      summary: Денежный поток по дням и категориям
      parameters:
        - $ref: '#/components/parameters/FromDateParam'
        - $ref: '#/components/parameters/ToDateParam'
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: object
                properties:
                  byDay:
                    type: array
                    items:
                      type: object
                      properties:
                        date: { type: string, format: date }
                        income: { type: integer }
                        expense: { type: integer }
                  byCategory:
                    type: array
                    items:
                      type: object
                      properties:
                        categoryId: { type: string, format: uuid }
                        income: { type: integer }
                        expense: { type: integer }
  /reports/budget-performance:
    get:
      tags: [Reports]
      summary: Бюджетные распределения и фактические значения
      parameters:
        - name: budgetId
          in: query
          required: true
          schema: { type: string, format: uuid }
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: object
                properties:
                  allocations:
                    type: array
                    items:
                      type: object
                      properties:
                        categoryId: { type: string, format: uuid }
                        limitAmount: { type: integer }
                        actualAmount: { type: integer }
                        remainingAmount: { type: integer }
                  summary:
                    type: object
                    properties:
                      totalLimit: { type: integer }
                      totalActual: { type: integer }
                      totalRemaining: { type: integer }
